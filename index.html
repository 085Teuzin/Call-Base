<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Base V2 - @085_Teuzinnn</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', 'Segoe UI', sans-serif; }
        body { 
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); 
            color: #fff; height: 100vh; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; overflow: hidden; 
        }
        .app-container { 
            width: 90%; max-width: 420px; background: rgba(22, 22, 22, 0.95); 
            padding: 30px; border-radius: 30px; border: 1px solid #ff4d00; 
            box-shadow: 0 0 20px rgba(255, 77, 0, 0.2); text-align: center; 
            backdrop-filter: blur(10px);
        }
        h1 { color: #ff4d00; font-size: 2.2rem; letter-spacing: -1px; margin-bottom: 20px; }
        .id-card { 
            background: #111; padding: 15px; border-radius: 15px; margin: 15px 0; 
            border: 1px solid #333; transition: 0.3s; cursor: pointer;
        }
        .id-card:hover { border-color: #ff4d00; background: #1a1a1a; }
        .id-card strong { color: #ff8c00; font-family: monospace; font-size: 1.2rem; }
        input { 
            width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #333; 
            background: #050505; color: #fff; text-align: center; margin-bottom: 10px;
            transition: 0.3s;
        }
        input:focus { border-color: #ff4d00; box-shadow: 0 0 10px rgba(255, 77, 0, 0.3); }
        .btn-orange { 
            background: linear-gradient(135deg, #ff4d00, #ff0000); color: #fff; 
            border: none; padding: 15px; border-radius: 12px; font-weight: 800; 
            cursor: pointer; width: 100%; transition: transform 0.2s;
        }
        .btn-orange:active { transform: scale(0.98); }
        .call-ui { display: none; }
        .avatar-area { 
            width: 120px; height: 120px; background: #111; border-radius: 50%; 
            margin: 20px auto; border: 4px solid #ff4d00; display: flex; 
            align-items: center; justify-content: center; font-size: 3.5rem;
            position: relative;
        }
        .pulse {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            border: 2px solid #ff4d00; animation: pulse-ani 2s infinite;
        }
        @keyframes pulse-ani { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.5); opacity: 0; } }
        .timer { font-family: monospace; color: #aaa; margin-bottom: 15px; display: block; }
        .controls-row { display: flex; justify-content: center; gap: 20px; margin-top: 25px; }
        .btn-circle { 
            width: 60px; height: 60px; border-radius: 50%; border: none; 
            font-size: 1.5rem; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; transition: 0.3s;
        }
        .btn-mic { background: #222; color: white; }
        .btn-mic.off { background: #ff0000; box-shadow: 0 0 15px rgba(255, 0, 0, 0.4); }
        .btn-hangup { background: #ff0000; color: white; transform: rotate(135deg); }
        .btn-chat { background: #ff8c00; color: white; position: relative; }
        .badge { position: absolute; top: -5px; right: -5px; background: white; color: black; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; display: none; align-items: center; justify-content: center; font-weight: bold; }
        #modal-chat { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.98); z-index: 100; padding: 25px; flex-direction: column; 
        }
        #chat-content { 
            flex: 1; overflow-y: auto; background: #0a0a0a; padding: 20px; 
            border-radius: 15px; margin-bottom: 15px; border: 1px solid #222; 
        }
        .msg { margin-bottom: 10px; line-height: 1.4; padding: 8px 12px; background: #161616; border-radius: 8px; width: fit-content; max-width: 80%; }
        .msg.me { background: #ff4d00; margin-left: auto; }
        footer { position: absolute; bottom: 20px; font-size: 0.8rem; opacity: 0.6; }
        footer a { color: #ff4d00; text-decoration: none; }
        .toast { position: fixed; top: 20px; background: #ff4d00; padding: 10px 20px; border-radius: 50px; font-weight: bold; transform: translateY(-100px); transition: 0.5s; z-index: 1000; }
        .toast.show { transform: translateY(0); }
    </style>
</head>
<body>

    <div id="toast" class="toast">ID Copiado!</div>

    <div class="app-container">
        <h1>Call Base</h1>

        <div id="lobby" class="lobby-section">
            <input type="text" id="nick-input" placeholder="Digite seu Nome">
            <div class="id-card" onclick="copyId()">
                <small style="color:#666">SEU ID (Clique para copiar)</small><br>
                <strong id="my-id">...</strong>
            </div>
            <input type="text" id="peer-id-input" placeholder="ID do Amigo">
            <button class="btn-orange" onclick="startCall()">INICIAR CHAMADA üìû</button>
        </div>

        <div id="call-screen" class="call-ui">
            <div class="avatar-area">
                <div id="voice-pulse" class=""></div>
                üë§
            </div>
            <h3 id="remote-nick-display">Conectando...</h3>
            <span class="timer" id="call-timer">00:00</span>
            
            <div class="controls-row">
                <button class="btn-circle btn-mic" id="mic-btn" onclick="toggleMic()">üéôÔ∏è</button>
                <button class="btn-circle btn-chat" onclick="toggleChat(true)">
                    üí¨
                    <div id="chat-badge" class="badge">0</div>
                </button>
                <button class="btn-circle btn-hangup" onclick="endCall()">üìû</button>
            </div>
        </div>
    </div>

    <div id="modal-chat">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2>Chat ao Vivo</h2>
            <button onclick="toggleChat(false)" style="background:none; border:none; color:white; font-size:2rem; cursor:pointer;">‚úï</button>
        </div>
        <div id="chat-content"></div>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="chat-input" placeholder="Escreva algo..." onkeypress="handleChatKey(event)">
            <button class="btn-orange" style="width: 100px; margin:0;" onclick="sendMessage()">Enviar</button>
        </div>
    </div>

    <footer>
        Desenvolvido por <a href="https://instagram.com/085_Teuzinnn" target="_blank">@085_Teuzinnn</a>
    </footer>

    <audio id="remote-audio" autoplay></audio>

    <script>
        const myIdElem = document.getElementById('my-id');
        const chatContent = document.getElementById('chat-content');
        const nickInput = document.getElementById('nick-input');
        const remoteAudio = document.getElementById('remote-audio');
        const chatBadge = document.getElementById('chat-badge');
        
        let peer = new Peer();
        let localStream;
        let currentConn;
        let currentCall;
        let myNick = "User";
        let timerInterval;
        let seconds = 0;
        let unreadCount = 0;

        nickInput.value = localStorage.getItem('last-nick') || "";

        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => { 
            localStream = stream; 
        }).catch(() => { showToast("Erro: Microfone Necess√°rio"); });

        peer.on('open', id => { myIdElem.innerText = id; });

        function showToast(text) {
            const t = document.getElementById('toast');
            t.innerText = text;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function copyId() {
            navigator.clipboard.writeText(myIdElem.innerText);
            showToast("ID Copiado com Sucesso!");
        }

        function startTimer() {
            seconds = 0;
            timerInterval = setInterval(() => {
                seconds++;
                const min = Math.floor(seconds / 60).toString().padStart(2, '0');
                const sec = (seconds % 60).toString().padStart(2, '0');
                document.getElementById('call-timer').innerText = `${min}:${sec}`;
            }, 1000);
        }

        function addLog(name, action, isMe = false) {
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'me' : ''}`;
            div.innerHTML = `<strong>${name}:</strong><br>${action}`;
            chatContent.appendChild(div);
            chatContent.scrollTop = chatContent.scrollHeight;
            
            if(!isMe && document.getElementById('modal-chat').style.display !== 'flex') {
                unreadCount++;
                chatBadge.innerText = unreadCount;
                chatBadge.style.display = 'flex';
            }
        }

        function setupConnection(conn) {
            currentConn = conn;
            conn.on('open', () => {
                myNick = nickInput.value || "An√¥nimo";
                localStorage.setItem('last-nick', myNick);
                conn.send({ type: 'nick', val: myNick });
                showCallUI();
                startTimer();
            });
            conn.on('data', data => {
                if(data.type === 'nick') {
                    document.getElementById('remote-nick-display').innerText = data.val;
                    showToast(`${data.val} entrou na call`);
                } else if(data.type === 'msg') {
                    addLog(data.from, data.val, false);
                } else if(data.type === 'action') {
                    showToast(`${data.from} ${data.val}`);
                }
            });
            conn.on('close', () => { endCall(); });
        }

        async function startCall() {
            if(!nickInput.value) return showToast("Digite seu nick primeiro!");
            const remoteId = document.getElementById('peer-id-input').value;
            if(!remoteId) return showToast("Insira o ID do amigo!");

            if(!localStream) localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            const call = peer.call(remoteId, localStream);
            const conn = peer.connect(remoteId);
            
            handleCall(call);
            setupConnection(conn);
        }

        peer.on('connection', setupConnection);

        peer.on('call', async call => {
            if(!localStream) localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            call.answer(localStream);
            handleCall(call);
        });

        function handleCall(call) {
            currentCall = call;
            call.on('stream', stream => {
                remoteAudio.srcObject = stream;
                document.getElementById('voice-pulse').className = 'pulse';
            });
        }

        function showCallUI() {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('call-screen').style.display = 'block';
        }

        function toggleMic() {
            const audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
            const btn = document.getElementById('mic-btn');
            const action = audioTrack.enabled ? "Ativou o Mic" : "Mutou o Mic";
            btn.classList.toggle('off');
            btn.innerText = audioTrack.enabled ? "üéôÔ∏è" : "üîá";
            currentConn.send({ type: 'action', from: myNick, val: action });
        }

        function toggleChat(show) {
            document.getElementById('modal-chat').style.display = show ? 'flex' : 'none';
            if(show) {
                unreadCount = 0;
                chatBadge.style.display = 'none';
            }
        }

        function handleChatKey(e) { if(e.key === 'Enter') sendMessage(); }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            if(!input.value) return;
            currentConn.send({ type: 'msg', from: myNick, val: input.value });
            addLog(myNick, input.value, true);
            input.value = "";
        }

        function endCall() {
            if(currentConn) currentConn.send({ type: 'action', from: myNick, val: "desconectou" });
            location.reload();
        }
    </script>
</body>
</html>