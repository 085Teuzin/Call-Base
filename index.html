<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <title>Web Call PWA</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* Reset e Base */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: #0a0f1a; 
            color: #e2e8f0; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
            position: fixed;
            display: flex;
            flex-direction: column;
        }

        /* LOBBY CENTRALIZADO */
        #lobby { 
            display: flex; flex-direction: column; height: 100%; 
            padding: 20px; align-items: center; justify-content: center; text-align: center;
        }
        .input-group { width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 12px; }
        input { 
            background: #161e2d; border: 2px solid #1e293b; padding: 16px; 
            border-radius: 14px; color: white; outline: none; font-size: 1rem; width: 100%;
        }
        input:focus { border-color: #3b82f6; }
        .btn-primary { 
            background: #3b82f6; color: white; border: none; padding: 16px; 
            border-radius: 14px; font-weight: bold; cursor: pointer; font-size: 1rem;
        }

        /* CALL UI RESPONSIVA */
        #call-ui { 
            display: none; flex-direction: column; height: 100%; width: 100%;
            padding: 20px; align-items: center; justify-content: space-between; 
        }

        .main-info { text-align: center; margin-top: 20px; }
        .avatar { 
            width: clamp(80px, 20vw, 120px); height: clamp(80px, 20vw, 120px); 
            background: #1e293b; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; font-size: 2.5rem; 
            border: 3px solid #3b82f6; position: relative; margin: 0 auto;
        }
        .pulse { 
            position: absolute; width: 100%; height: 100%; background: #3b82f6; 
            border-radius: 50%; opacity: 0; z-index: -1; transition: 0.2s;
        }
        
        /* CONTROLES ESTILO APP NATIVO */
        .controls { 
            display: grid; grid-template-columns: repeat(4, 1fr); 
            gap: 15px; width: 100%; max-width: 360px; margin-bottom: 20px;
        }
        .btn-c { 
            width: 60px; height: 60px; border-radius: 50%; 
            background: #3b82f6; border: none; color: white; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.4rem; cursor: pointer; margin: 0 auto;
            transition: all 0.3s ease;
        }
        /* Classe para estado DESABILITADO (Fica branco/cinza claro) */
        .btn-c.off { background: #f8fafc !important; color: #0a0f1a !important; }

        .hangup { background: #ef4444 !important; }

        /* CHAT CENTRALIZADO E RESPONSIVO */
        .popup { 
            display: none; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); width: 90%; max-width: 400px; 
            height: 70%; background: #161e2d; border-radius: 24px; 
            z-index: 100; flex-direction: column; border: 1px solid #334155;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }
        .p-head { padding: 15px 20px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { background: #1e293b; padding: 10px 14px; border-radius: 15px; max-width: 85%; font-size: 0.9rem; line-height: 1.4; }
        .msg.me { background: #3b82f6; align-self: flex-end; color: white; }
        .chat-bar { padding: 15px; display: flex; gap: 10px; background: #0f172a; border-radius: 0 0 24px 24px; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1 style="color:#3b82f6; font-size: 2.5rem; margin-bottom: 5px;">Web Call</h1>
        <p style="color:#64748b; margin-bottom: 30px;">P2P Privado & Seguro</p>
        <div class="input-group">
            <input type="text" id="nick-input" placeholder="Seu Nome">
            <input type="text" id="room-input" placeholder="ID da Sala">
            <button id="start-btn" class="btn-primary">ENTRAR NA CHAMADA</button>
        </div>
    </div>

    <div id="call-ui">
        <div class="main-info">
            <div class="avatar"><div class="pulse" id="pulse"></div><span id="av-txt">?</span></div>
            <h2 id="room-name" style="margin-top:15px; letter-spacing: 1px;">SALA</h2>
            <div id="timer" style="color:#3b82f6; font-family: monospace; font-weight: bold;">00:00</div>
        </div>

        <div class="controls">
            <button class="btn-c" id="mute-btn" title="Mudar Mic">ðŸŽ¤</button>
            <button class="btn-c" id="speaker-btn" title="Mudar Ãudio">ðŸ”Š</button>
            <button class="btn-c off" id="chat-btn" title="Chat">ðŸ’¬</button>
            <button class="btn-c hangup" onclick="location.reload()">ðŸ“ž</button>
        </div>
    </div>

    <div id="chat-popup" class="popup">
        <div class="p-head">
            <b>Mensagens</b> 
            <span onclick="document.getElementById('chat-popup').style.display='none'" style="cursor:pointer; padding:5px">âœ•</span>
        </div>
        <div id="messages"></div>
        <div class="chat-bar">
            <input type="text" id="chat-input" style="flex:1; padding: 10px;" placeholder="Escreva...">
            <button id="send-btn" style="background:none; border:none; font-size: 1.5rem;">âž”</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }

        const firebaseConfig = {
            apiKey: "AIzaSyBq9-vsFpAgEtXJ--KH6knNKEpXXVgkGrc",
            authDomain: "conexao-geral-teuzin.firebaseapp.com",
            databaseURL: "https://conexao-geral-teuzin-default-rtdb.firebaseio.com",
            projectId: "conexao-geral-teuzin"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const peer = new Peer();
        let myStream, myNick, activeConnections = new Set();
        let connObjects = [];

        navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
            myStream = s;
            setupVisualizer(s);
        });

        document.getElementById('start-btn').onclick = () => {
            myNick = document.getElementById('nick-input').value.trim();
            const room = document.getElementById('room-input').value.trim().toLowerCase();
            if(!myNick || !room) return;

            document.getElementById('lobby').style.display = 'none';
            document.getElementById('call-ui').style.display = 'flex';
            document.getElementById('av-txt').innerText = myNick[0].toUpperCase();
            document.getElementById('room-name').innerText = "#" + room;

            const roomRef = ref(db, 'rooms/' + room);
            push(roomRef, { id: peer.id, nick: myNick });

            onChildAdded(roomRef, snap => {
                const data = snap.val();
                if(data.id !== peer.id && !activeConnections.has(data.id)) {
                    activeConnections.add(data.id);
                    peer.call(data.id, myStream);
                    const conn = peer.connect(data.id);
                    setupConn(conn);
                }
            });
            startTimer();
        };

        peer.on('call', call => {
            call.answer(myStream);
            call.on('stream', s => {
                const audioId = `audio-${call.peer}`;
                if(!document.getElementById(audioId)) {
                    const audio = new Audio();
                    audio.id = audioId;
                    audio.srcObject = s;
                    audio.play();
                }
            });
        });

        peer.on('connection', setupConn);

        function setupConn(conn) {
            if(!activeConnections.has(conn.peer)) {
                activeConnections.add(conn.peer);
            }
            
            // Evita duplicatas na lista de objetos de envio
            if(!connObjects.find(c => c.peer === conn.peer)) {
                connObjects.push(conn);
            }

            conn.on('data', data => {
                // BUG FIX: Verifica se a mensagem jÃ¡ foi processada (ID de timestamp ou similar seria ideal, mas usaremos lÃ³gica de UI)
                renderMsg(data.nick, data.msg, false);
                if (document.visibilityState !== 'visible') {
                    showNotification(data.nick, data.msg);
                }
            });
        }

        // FUNÃ‡ÃƒO DE MUTE COM FEEDBACK DE COR
        document.getElementById('mute-btn').onclick = function() {
            const track = myStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            this.innerText = track.enabled ? "ðŸŽ¤" : "ðŸ”‡";
            this.classList.toggle('off', !track.enabled); // Fica branco se mutado
        };

        // FUNÃ‡ÃƒO DE SPEAKER COM FEEDBACK DE COR
        let speakerOn = true;
        document.getElementById('speaker-btn').onclick = function() {
            speakerOn = !speakerOn;
            document.querySelectorAll('audio').forEach(a => a.volume = speakerOn ? 1 : 0);
            this.innerText = speakerOn ? "ðŸ”Š" : "ðŸ”ˆ";
            this.classList.toggle('off', !speakerOn); // Fica branco se desligar Ã¡udio
        };

        // BOTÃƒO CHAT (Sempre "off" a menos que esteja aberto)
        document.getElementById('chat-btn').onclick = function() {
            const chat = document.getElementById('chat-popup');
            const isVisible = chat.style.display === 'flex';
            chat.style.display = isVisible ? 'none' : 'flex';
            this.classList.toggle('off', isVisible); // Inverte a lÃ³gica de cor
        };

        function renderMsg(n, m, isMe) {
            const box = document.getElementById('messages');
            // ProteÃ§Ã£o contra mensagens vazias
            if(!m) return;
            box.innerHTML += `<div class="msg ${isMe?'me':''}"><b>${n}</b><br>${m}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        document.getElementById('send-btn').onclick = () => {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;

            connObjects.forEach(c => {
                if(c.open) c.send({nick: myNick, msg: msg});
            });

            renderMsg('VocÃª', msg, true);
            input.value = '';
        };

        function showNotification(user, text) {
            if (Notification.permission === 'granted') {
                navigator.serviceWorker.ready.then(reg => {
                    reg.showNotification(user, { body: text, icon: 'https://cdn-icons-png.flaticon.com/512/3616/3616215.png' });
                });
            }
        }

        function setupVisualizer(stream) {
            const ctx = new AudioContext();
            const src = ctx.createMediaStreamSource(stream);
            const ana = ctx.createAnalyser();
            src.connect(ana);
            const data = new Uint8Array(ana.frequencyBinCount);
            function loop() {
                ana.getByteFrequencyData(data);
                let v = data.reduce((a,b)=>a+b)/data.length;
                document.getElementById('pulse').style.opacity = v > 15 ? '0.5' : '0';
                document.getElementById('pulse').style.transform = `scale(${1+v/40})`;
                requestAnimationFrame(loop);
            }
            loop();
        }

        function startTimer() {
            let s = 0;
            setInterval(() => {
                s++;
                let m = Math.floor(s/60), sec = s%60;
                document.getElementById('timer').innerText = `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
            }, 1000);
        }
    </script>
</body>
</html>