<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f97316">
    <title>Web Call - Made By: @085_Teuzinnn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #f1f5f9; overflow: hidden; position: fixed; width: 100vw; height: 100vh; }
        .bg-orange-custom { background-color: #f97316; }
        .border-orange-custom { border-color: #f97316; }
        .text-orange-custom { color: #f97316; }
        .pulse { position: absolute; width: 100%; height: 100%; background: #f97316; border-radius: 50%; opacity: 0; z-index: -1; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4">

    <div id="lobby" class="w-full max-w-sm flex flex-col items-center animate-fade-in">
        <h1 class="text-4xl font-black text-orange-custom mb-2">Web Call</h1>
        <p class="text-slate-400 mb-8 text-center">ComunicaÃ§Ã£o P2P Segura</p>
        
        <div class="w-full space-y-4">
            <input type="text" id="nick-input" placeholder="Seu apelido" class="w-full bg-slate-800 border-2 border-slate-700 p-4 rounded-2xl focus:border-orange-custom outline-none transition-all">
            <input type="text" id="room-input" placeholder="ID da Sala" class="w-full bg-slate-800 border-2 border-slate-700 p-4 rounded-2xl focus:border-orange-custom outline-none transition-all">
            <button id="start-btn" class="w-full bg-orange-custom text-slate-900 font-bold p-4 rounded-2xl hover:brightness-110 active:scale-95 transition-all">ENTRAR NA CHAMADA</button>
        </div>

        <footer class="text-center mt-5 text-gray-500 text-sm">
            Made By: <a href="https://instagram.com/085_Teuzinnn" target="_blank" class="text-blue-400 hover:text-blue-300 font-semibold transition duration-200">@085_Teuzinnn</a>
        </footer>
    </div>

    <div id="call-ui" class="hidden w-full h-full flex flex-col items-center justify-between py-10">
        <div class="text-center">
            <div class="relative w-32 h-32 mx-auto flex items-center justify-center bg-slate-800 rounded-full border-4 border-orange-custom">
                <div id="pulse" class="pulse"></div>
                <span id="av-txt" class="text-5xl font-bold">?</span>
            </div>
            <h2 id="display-room" class="mt-4 text-xl font-bold tracking-widest text-slate-300">#SALA</h2>
            <div id="timer" class="text-orange-custom font-mono text-lg font-bold">00:00</div>
        </div>

        <div class="grid grid-cols-5 gap-3 w-full max-w-md px-4">
            <button class="flex items-center justify-center w-full aspect-square bg-orange-custom text-slate-900 rounded-2xl text-xl transition-all" id="mute-btn">ðŸŽ¤</button>
            <button class="flex items-center justify-center w-full aspect-square bg-orange-custom text-slate-900 rounded-2xl text-xl transition-all" id="speaker-btn">ðŸ”Š</button>
            <button class="flex items-center justify-center w-full aspect-square bg-slate-800 text-white rounded-2xl text-xl transition-all" id="users-btn">ðŸ‘¥</button>
            <button class="flex items-center justify-center w-full aspect-square bg-slate-800 text-white rounded-2xl text-xl transition-all" id="chat-btn">ðŸ’¬</button>
            <button class="flex items-center justify-center w-full aspect-square bg-red-500 text-white rounded-2xl text-xl" onclick="location.reload()">ðŸ“ž</button>
        </div>
    </div>

    <div id="chat-popup" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-md h-[70vh] rounded-3xl flex flex-col shadow-2xl">
            <div class="p-5 border-b border-slate-700 flex justify-between items-center">
                <b class="text-orange-custom">Chat da Sala</b>
                <button onclick="closePopups()" class="text-slate-400 p-2">âœ•</button>
            </div>
            <div id="messages" class="flex-1 overflow-y-auto p-5 space-y-4"></div>
            <div class="p-4 bg-slate-800/50 flex gap-2 rounded-b-3xl">
                <input type="text" id="chat-input" class="flex-1 bg-slate-800 border border-slate-700 p-3 rounded-xl outline-none focus:border-orange-custom" placeholder="Sua mensagem...">
                <button id="send-btn" class="bg-orange-custom text-slate-900 px-5 rounded-xl font-bold">âž”</button>
            </div>
        </div>
    </div>

    <div id="users-popup" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-md h-[60vh] rounded-3xl flex flex-col shadow-2xl">
            <div class="p-5 border-b border-slate-700 flex justify-between items-center">
                <b class="text-orange-custom">Participantes</b>
                <button onclick="closePopups()" class="text-slate-400 p-2">âœ•</button>
            </div>
            <ul id="user-list" class="p-5 space-y-3"></ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBq9-vsFpAgEtXJ--KH6knNKEpXXVgkGrc",
            authDomain: "conexao-geral-teuzin.firebaseapp.com",
            databaseURL: "https://conexao-geral-teuzin-default-rtdb.firebaseio.com",
            projectId: "conexao-geral-teuzin"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const peer = new Peer({ config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] }});

        let myStream, myNick, currentRoom;
        let connections = {};
        let participants = {};

        navigator.mediaDevices.getUserMedia({ audio: true }).then(s => { myStream = s; setupVisualizer(s); });

        document.getElementById('start-btn').onclick = () => {
            myNick = document.getElementById('nick-input').value.trim();
            currentRoom = document.getElementById('room-input').value.trim().toLowerCase();
            if(!myNick || !currentRoom) return;
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('call-ui').classList.remove('hidden');
            document.getElementById('av-txt').innerText = myNick[0].toUpperCase();
            document.getElementById('display-room').innerText = "#" + currentRoom;
            const roomRef = ref(db, 'rooms/' + currentRoom);
            push(roomRef, { id: peer.id, nick: myNick });
            onChildAdded(roomRef, snap => {
                const user = snap.val();
                if(user.id !== peer.id) {
                    connectToUser(user.id, user.nick);
                    systemMsg(`${user.nick} entrou na sala`);
                }
                participants[user.id] = user.nick;
                updateUserList();
            });
            startTimer();
        };

        function connectToUser(userId, nick) {
            const call = peer.call(userId, myStream);
            const conn = peer.connect(userId);
            setupDataConn(conn, nick);
            call.on('stream', s => playStream(s, userId));
            call.on('close', () => { if(participants[userId]) setTimeout(() => connectToUser(userId, nick), 2000); });
        }

        peer.on('call', call => {
            call.answer(myStream);
            call.on('stream', s => playStream(s, call.peer));
        });

        peer.on('connection', conn => setupDataConn(conn, "Amigo"));

        function setupDataConn(conn, nick) {
            connections[conn.peer] = conn;
            conn.on('data', data => {
                if(data.type === 'chat') renderMsg(data.nick, data.msg, false, data.time);
                else if(data.type === 'system') systemMsg(`${data.nick} ${data.action}`);
            });
        }

        function playStream(stream, id) {
            if(document.getElementById('audio-'+id)) return;
            const audio = new Audio(); audio.id = 'audio-'+id; audio.srcObject = stream; audio.play();
        }

        function renderMsg(nick, msg, isMe, time) {
            const box = document.getElementById('messages');
            const now = time || new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const align = isMe ? 'ml-auto bg-orange-custom text-slate-900' : 'mr-auto bg-slate-800 text-white';
            box.innerHTML += `<div class="max-w-[85%] p-3 rounded-2xl ${align} shadow-lg"><div class="flex justify-between gap-4 text-[10px] mb-1 font-bold uppercase opacity-70"><span>${nick}</span><span>${now}</span></div><div class="text-sm">${msg}</div></div>`;
            box.scrollTop = box.scrollHeight;
        }

        function systemMsg(text) {
            document.getElementById('messages').innerHTML += `<div class="w-full text-center text-[10px] text-slate-500 italic py-1">SISTEMA: ${text}</div>`;
        }

        document.getElementById('send-btn').onclick = () => {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            Object.values(connections).forEach(c => { if(c.open) c.send({ type: 'chat', nick: myNick, msg: msg, time: time }); });
            renderMsg('VocÃª', msg, true, time);
            input.value = '';
        };

        document.getElementById('mute-btn').onclick = function() {
            const t = myStream.getAudioTracks()[0]; t.enabled = !t.enabled;
            this.className = t.enabled ? 'flex items-center justify-center w-full aspect-square bg-orange-custom text-slate-900 rounded-2xl text-xl transition-all' : 'flex items-center justify-center w-full aspect-square bg-white text-slate-900 rounded-2xl text-xl transition-all';
            this.innerText = t.enabled ? 'ðŸŽ¤' : 'ðŸ”‡';
            broadcastSystem(t.enabled ? "desmutou" : "mutou o microfone");
        };

        document.getElementById('speaker-btn').onclick = function() {
            const audios = document.querySelectorAll('audio');
            const isActive = this.classList.contains('bg-orange-custom');
            audios.forEach(a => a.muted = isActive);
            this.className = !isActive ? 'flex items-center justify-center w-full aspect-square bg-orange-custom text-slate-900 rounded-2xl text-xl transition-all' : 'flex items-center justify-center w-full aspect-square bg-white text-slate-900 rounded-2xl text-xl transition-all';
            this.innerText = !isActive ? 'ðŸ”Š' : 'ðŸ”ˆ';
            broadcastSystem(!isActive ? "ativou o Ã¡udio" : "desligou o Ã¡udio");
        };

        function broadcastSystem(action) {
            systemMsg(`VocÃª ${action}`);
            Object.values(connections).forEach(c => { if(c.open) c.send({ type: 'system', nick: myNick, action: action }); });
        }

        document.getElementById('chat-btn').onclick = () => document.getElementById('chat-popup').classList.remove('hidden');
        document.getElementById('users-btn').onclick = () => { updateUserList(); document.getElementById('users-popup').classList.remove('hidden'); };
        window.closePopups = () => { document.querySelectorAll('.fixed').forEach(p => p.classList.add('hidden')); };

        function updateUserList() {
            const l = document.getElementById('user-list');
            l.innerHTML = `<li class="flex items-center gap-3 bg-slate-800 p-4 rounded-xl"><div class="w-2 h-2 rounded-full bg-orange-custom"></div> ${myNick} (VocÃª)</li>`;
            Object.entries(participants).forEach(([id, n]) => { if(id !== peer.id) l.innerHTML += `<li class="flex items-center gap-3 bg-slate-800 p-4 rounded-xl"><div class="w-2 h-2 rounded-full bg-orange-custom"></div> ${n}</li>`; });
        }

        function setupVisualizer(s) {
            const ctx = new AudioContext(); const ana = ctx.createAnalyser(); ctx.createMediaStreamSource(s).connect(ana);
            const d = new Uint8Array(ana.frequencyBinCount);
            function loop() {
                ana.getByteFrequencyData(d); let v = d.reduce((a,b)=>a+b)/d.length;
                document.getElementById('pulse').style.opacity = v > 15 ? '0.4' : '0';
                document.getElementById('pulse').style.transform = `scale(${1+v/45})`;
                requestAnimationFrame(loop);
            }
            loop();
        }

        function startTimer() {
            let s = 0; setInterval(() => { s++; let m = Math.floor(s/60), sc = s%60; document.getElementById('timer').innerText = `${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`; }, 1000);
        }
    </script>
</body>
</html>